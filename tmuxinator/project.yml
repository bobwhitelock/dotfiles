
# Note: need to run `sync` for this session to be available.

<%
require "json"

abort "Usage: mux start project PATH" unless @args.size == 1 && File.exist?(@args[0])

project_path = File.expand_path(@args[0])
project_owner = File.basename(File.dirname(project_path))
project_name = File.basename(project_path)

project_specific_setup = \
  if File.exist?("#{project_path}/package-lock.json")
    {npm: ["npm install", "npm start"]}
  elsif File.exist?("#{project_path}/Makefile")
    ["make"]
  else
    # XXX This does mean `aider` running and above setup running are mutually
    # exclusive, so this should perhaps be reworked.
    # XXX `aider` will run at top of repo, limiting benefits of working on a
    # sub-directory of repo - perhaps should be able to specify directory to
    # work in? Or can just manually exit and re-run in these cases, too hard to
    # know what should always happen automatically?
    "aider"
  end.to_json
%>
# XXX maybe use window layout like this for normal things? Aider at the top left, small term bottom left, vim right?
# `2: shaker* (3 panes) [239x58] [layout 915a,239x58,0,0{118x58,0,0[118x43,0,0,4,118x14,0,44,7],120x58,119,0,8}] @3 (active)`

name: <%= [project_owner, project_name].join('/') %>
startup_window: <%= project_name %>
# XXX Don't reprompt for this when it's already added.
on_project_start: ssh-add ~/.ssh/id_rsa.bob

windows:
  - notes:
      root: <%= ENV.fetch('NOTES') %>
      layout: even-horizontal
      panes:
        - gpl
        - vim 'stream.md'

  - <%= project_name %>:
      layout: '6827,274x73,0,0{136x73,0,0[136x36,0,0,41,136x36,0,37,50],137x73,137,0,47}'
      root: <%= project_path %>
      panes:
        - <%= project_specific_setup %>
        # XXX Add ability to have custom per-project config here, which can
        # also be specified in dotfiles-private as well - and can then resolve
        # https://github.com/bobwhitelock/dotfiles-private/issues/2.
        -
        - vim

  - dotfiles:
      root: <%= ENV.fetch('DOTFILES') %>
      layout: even-horizontal
      panes:
        - gpl
        - vim
